local a,b,c,d,e,f,g,h,i,j,k,l,m,n=component,computer,unicode,math,{"/init.lua","/OS.lua"},{},{},{}local function o(p)local q={b.pullSignal(p)}q[1]=q[1]or""if cyan and(q[1]:match("ey")and not cyan:match(q[5])or q[1]:match("cl")and not cyan:match(q[4]))then return""end;g[q[4]or""]=q[1]:match"do"and 1;if g[29]and(g[46]or g[32])and q[1]:match"do"then return"F"end;return table.unpack(q)end;local function r(s,t,u,v,w)w=w or xpcall;local x,y=load("return "..s,t,F,u)if not x then x,y=load(s,t,F,u)end;if x then u=a.invoke;a.invoke=v and function(z,A,...)if k and z==k.address and A=="set"then k.setPaletteColor(9,0x969696)k.setPaletteColor(11,0xb4b4b4)a.invoke=u end;return u(z,A,...)end or u;return w(x,debug.traceback)end;return F,y end;local function B(C)return a.list(C)()and a.proxy(a.list(C)())end;local function D(E,G)n={}for H in E:gmatch"[^\r\n]+"do n[#n+1]=H:gsub("\t",G and"    "or"")end end;local function I(p,J,K,L,M,s,N)L=b.uptime()+(p or d.huge)::O::M,N,N,s=o(L-b.uptime())if M=="F"or M:match"do"and(s==J or J==0)then return 1,K and K()elseif b.uptime()<L then goto O end end;local function P(Q,R,S,T,U)k.setBackground(T or 0x002b36)k.setForeground(U or 0x8cb9c5)k.set(Q,R,S)end;local function V(Q,R,W,X,T,U)k.setBackground(T or 0x002b36)k.setForeground(U or 0x8cb9c5)k.fill(Q,R,W,X," ")end;local function Y()V(1,1,i,j)end;local function Z(_)return d.floor(i/2-_/2)end;local function a0(R,E,T,U)P(Z(c.len(E)),R,E,T,U)end;local function a1()k,l=B"gp",B"sc"if k and l then if k.getScreen()~=l.address then k.bind(l.address)end;local a2,a3,a4=l.getAspectRatio()i,j=k.maxResolution()a4=2*(16*a2-4.5)/(16*a3-4.5)if a4>i/j then j=d.floor(i/a4)else i=d.floor(j*a4)end;k.set(1,1,"")k.setResolution(i,j)k.setPaletteColor(9,0x002b36)k.setPaletteColor(11,0x8cb9c5)end end;local function a5(E,a6,a7,J,K,R)if k and l then Y()D(E)R=d.ceil(j/2-#n/2)if a6 then a0(R-1,a6,0x002b36,0xffffff)R=R+1 end;for a8=1,#n do a0(R,n[a8])R=R+1 end;I(a7 or 0,J or 0,K)end end;local function a9(E,aa)return c.len(E)>aa and c.sub(E,1,aa).."…"or E end;local function ab(ac,R,ad,ae,U)local E,af,ag,ah,ai,Q,M,aj,s,N="",c.len(ac),1,1;U=U or 0x8cb9c5::O::Q=ad and Z(c.len(E)+af)or 1;ai=Q+af+ag-1;V(1,R,i,1)P(Q,R,ac..E,F,U)if ai<=i then P(ai,R,k.get(ai,R),ah and U or 0x002b36,ah and 0x002b36 or U)end;M,N,aj,s=o(.5)if M:match"do"then if s==203 and ag>1 then ag=ag-1 elseif s==205 and ag<=c.len(E)then ag=ag+1 elseif s==200 and ae then E=ae;ag=c.len(ae)+1 elseif s==208 and ae then E=""ag=1 elseif s==14 and#E>0 and ag>1 then E=g[29]and""or c.sub(c.sub(E,1,ag-1),1,-2)..c.sub(E,ag,-1)ag=g[29]and 1 or ag-1 elseif s==28 then return E elseif aj>=32 and c.len(af..E)<i-af then E=c.sub(E,1,ag-1)..c.char(aj)..c.sub(E,ag,-1)ag=ag+1 end;ah=1 elseif M:match"cl"then E=c.sub(E,1,ag-1)..aj..c.sub(E,ag,-1)ag=ag+c.len(aj)elseif M:match"mp"or M=="F"then m=M:match"mp"and 1;return elseif not M:match"up"then ah=not ah end;goto O end;local function ak(z)local B,al,am,a8=a.proxy(z),{s=1,z=1}if B and z~=b.tmpAddress()then a8=#f+1;f[a8]={r=B,l=al,d=B,p=function(an,R)an=an and Y()or an;a0(R or j/2,an and("Booting %s from %s (%s)"):format(am,B.getLabel()or"N/A",a9(z,i>80 and 36 or 6))or am and("Boot%s %s (%s)"):format((#al==1 and" "..am or"").." from",a9(B.getLabel()or"N/A",6),a9(z,6))or("Boot from %s (%s) isn't available"):format(B.getLabel()or"N/A",a9(z,6)),F,not an and 0xffffff)an=an and not h and cyan:match("$")and(a5("Hold ENTER to boot")or I(F,28))end}f[a8].b=function()if am then local ao,ap,x,aq,y=B.open(am,"r"),""::O::x=B.read(ao,d.huge)if x then ap=ap..x;goto O end;B.close(ao)pcall(f[a8].p,1)x=b.getBootAddress()~=z and b.setBootAddress(z)aq,y=r(ap,"="..am,F,1)aq=aq and b.shutdown()a1()a5(y,"¯\\_(ツ)_/¯",d.huge,0,b.shutdown)error(y)end end;for ar=1,#e do if B.exists(e[ar])then am=am or e[ar]al[#al+1]={e[ar],function()am=e[ar]f[a8].b()end}end end end end;local function as()f={}ak(b.getBootAddress()or"")for z in next,a.list"file"do ak(z~=b.getBootAddress()and z or"")end end;local function at(au,R,av,aw,ax,ay)local az,Q=0;for a8=1,#au do az=az+c.len(au[a8][1])+av end;az=az-av;Q=Z(az)if ay then ay()end;for a8=1,#au do if au.s==a8 and ax then V(Q-av/2,R-d.floor(aw/2),c.len(au[a8][1])+av,aw,0x8cb9c5)P(Q,R,au[a8][1],0x8cb9c5,0x002b36)else P(Q,R,au[a8][1],0x002b36,0x8cb9c5)end;Q=Q+c.len(au[a8][1])+av end end;local function aA(u,ap,aB,E)Y()u=setmetatable({print=function(...)E=table.pack(...)for a8=1,E.n do if type(E[a8])=="table"then aB=''for aC,aD in pairs(E[a8])do aB=aB..tostring(aC).."    "..tostring(aD).."\n"end;E[a8]=aB else E[a8]=tostring(E[a8])end end;D(table.concat(E,"    "),1)for a8=1,#n do k.copy(1,1,i,j-1,0,-1)V(1,j-1,i,1)P(1,j-1,n[a8])end end,proxy=B,sleep=function(p)I(p,32,error)end},{__index=_G})::O::ap=ab("> ",j,F,ap,0xffffff,u)if ap then u.print("> "..ap)V(1,j,i,1)P(1,j,">")u.print(select(2,r(ap,"=shell",u)))goto O end end;local function aE()h=1,not k and error("No drives available")::aF::local aG,aH,aI,aJ,M,s,aK,aL,R,aM,aN,N={s=1}aI={s=1,p=1,{"Halt",b.shutdown},{"Shell",aA},B"net"and{"Netboot",function()Y()a0(j/2-1,"Netboot",F,0xffffff)aL=ab("URL: ",j/2+1,1,F,0x8cb9c5)if aL and#aL>0 then local ao,ap,x=B"net".request(aL,F,F,{["user-agent"]="Netboot"}),""if ao then a5("Downloading script...","Netboot")::O::x=ao.read()if x then ap=ap..x;goto O end;ap=select(2,r(ap,"=stdin",F,1,pcall))or""a1()a5(ap,"Netboot",#ap==0 and 0 or d.huge)else a5("Invalid URL","Netboot",d.huge)end end end}}aH=#aI+1;m=F;aN=F;as()for a8=1,#f do aG[a8]={a9(f[a8].d.getLabel()or"N/A",6),function()if#f[a8].l>0 then aN=a8;aJ=f[aN].l;if#aJ==1 then aJ[1][2]()end end end}end;aJ=#f>0 and aG or aI::O::pcall(function()Y()if aJ.z then a0(j/2-2,"Select boot entry",F,0xffffff)at(aJ,j/2+2,6,3,1)else R=j/2-(#f>0 and-1 or 1)at(aG,R-4,8,3,not aJ.p and 1,function()if#f>0 then aM=f[aG.s].r;f[aG.s].p(F,R+3)a0(R+5,("Storage %s%% / %s / %s"):format(d.floor(aM.spaceUsed()/(aM.spaceTotal()/100)),aM.isReadOnly()and"Read only"or"Read & Write",aM.spaceTotal()<2^20 and"FDD"or aM.spaceTotal()<2^20*12 and"HDD"or"RAID"))for a8=aH,#aI do aI[a8]=F end;aI[aH]={"Rename",function()Y()a0(j/2-1,"Rename",F,0xffffff)aK=ab("Enter new name: ",j/2+1,1,F,0x8cb9c5)if aK and#aK>0 then aM.setLabel(aK)aG[aG.s][1]=a9(aM.getLabel()or"N/A",6)end end}if not aM.isReadOnly()then aI[aH+1]={"Format",function()aM.remove("/")aM.setLabel(F)aG[aG.s][1]=a9(aM.getLabel()or"N/A",6)end}end else a0(R+3,"No drives available",F,0xffffff)end end)at(aI,R,6,1,aJ.p and 1 or F)end end)M,N,N,s=o()N=M=="F"and b.shutdown()if M:match"do"then aJ=(s==200 or s==208)and(aJ.z and aG or#f>0 and(aJ.p and aG or aI))or aJ;aJ.s=s==203 and(aJ.s==1 and#aJ or aJ.s-1)or s==205 and(aJ.s==#aJ and 1 or aJ.s+1)or aJ.s;if s==28 then pcall(aJ[aJ.s][2])end end;if M:match"mp"or m then pcall(a1)goto aF end;goto O end;b.getBootAddress=function()return B"pro"and B"pro".getData()end;b.setBootAddress=function(aO)return B"pro"and B"pro".setData(aO)end;as()a1()a5("Hold ALT to stay in bootloader",F,1,56,aE)for a8=1,#f do f[a8].b()end;aE()