local a,b,c,d,e,f,g,h,i,j,k,l={"/init.lua","/OS.lua"},{},{},{},F;local function m(n)local o={computer.pullSignal(n)}o[1]=o[1]or""if#o>0 and d.n>0 and(o[1]:match("ey")and not d[o[5]]or o[1]:match("cl")and not d[o[4]])then return""end;c[o[4]or""]=o[1]:match"do"and 1;if c[29]and(c[46]or c[32])and o[1]:match"do"then return"F"end;return table.unpack(o)end;local function p(q,r,s,t,u)u=u or xpcall;local v,w=load("return "..q,r,F,s)if not v then v,w=load(q,r,F,s)end;if v then s=component.invoke;component.invoke=t and i and i.address and function(x,y,...)if i and x==i.address and y=="set"then i.setPaletteColor(9,0x969696)i.setPaletteColor(11,0xb4b4b4)end;component.invoke=s;return s(x,y,...)end or s;return u(v,debug.traceback)end;return F,w end;local function z(A)return component.list(A)()and component.proxy(component.list(A)())end;local function B(C,D)k={}for E in C:gmatch"[^\r\n]+"do k[#k+1]=E:gsub("\t",D and"    "or"")end end;local function G(n,H,I)local J,K,q,L=computer.uptime()+(n or math.huge)::M::K,L,L,q=m(J-computer.uptime())if K=="F"or K:match"do"and(q==H or H==0)then return 1,I and I()elseif computer.uptime()<=J then goto M end end;local function N(O,P,Q,R,S)i.setBackground(R or 0x002b36)i.setForeground(S or 0x8cb9c5)i.set(O,P,Q)end;local function T(O,P,U,V,R,S)i.setBackground(R or 0x002b36)i.setForeground(S or 0x8cb9c5)i.fill(O,P,U,V," ")end;local function W()T(1,1,g,h)end;local function X(Y)return math.floor(g/2-Y/2)end;local function Z(P,C,R,S)N(X(unicode.len(C)),P,C,R,S)end;local function _()i=z"gp"if i and i.bind(component.list"sc"())then i.setPaletteColor(9,0x002b36)i.setPaletteColor(11,0x8cb9c5)g,h=i.maxResolution()W()return 1 end;g,h=0,0 end;local function a0(C,a1,a2,H,I,w,a3)if a3 then I()elseif _()then B(C)local P=math.ceil(h/2-#k/2)if a1 then Z(P-1,a1,0x002b36,0xffffff)P=P+1 end;for a4=1,#k do Z(P,k[a4])P=P+1 end;return G(a2 or 0,H or 0,I)elseif w then error(C)end end;local function a5(C,a6)return unicode.len(C)>a6 and unicode.sub(C,1,a6).."…"or C end;local function a7(a8,a9,P,aa,ab,S)S=S or 0xffffff;local a7,ac,ad,ae,af,O,ag,K,ah,q,L="",unicode.len(a8),1,1::M::K,L,ah,q=m(ae and 0 or 0.5)if K:match"do"then if ah>=32 and unicode.len(ac..a7)<g-ac then a7=unicode.sub(a7,1,ad-1)..unicode.char(ah)..unicode.sub(a7,ad,-1)ad=ad+1 elseif ah==8 and#a7>0 and ad>1 then a7=unicode.sub(unicode.sub(a7,1,ad-1),1,-2)..unicode.sub(a7,ad,-1)ad=ad-1 elseif ah==13 then T(1,P,g,1)return a7 elseif q==203 and ad>1 then ad=ad-1 elseif q==205 and ad<=unicode.len(a7)then ad=ad+1 elseif q==200 and ab then a7=ab;ad=unicode.len(ab)+1 elseif q==208 and ab then a7=""ad=1 end;af=1 elseif K:match"cl"then a7=unicode.sub(a7,1,ad-1)..ah..unicode.sub(a7,ad,-1)ad=ad+unicode.len(ah)elseif K:match"mp"or K=="F"then j=K:match"mp"and 1;return elseif not K:match"up"then af=not af end;ae=F;O=aa and X(unicode.len(a7)+ac)or a9;ag=O+ac+ad-1;T(1,P,g,1)N(O,P,a8 ..a7,0x002b36,S)if ag<=g then N(ag,P,i.get(ag,P),af and S or 0x002b36,af and 0x002b36 or S)end;goto M end;local function ai(...)local C=table.pack(...)for a4=1,C.n do C[a4]=tostring(C[a4])end;B(table.concat(C,"    "),1)for a4=1,#k do i.copy(1,1,g,h-1,0,-1)T(1,h-1,g,1)N(1,h-1,k[a4])end end;local function aj(x)local z,ak,a4=component.proxy(x)if z and x~=computer.tmpAddress()then a4=#b+1;for al=1,#a do if z.exists(a[al])then ak=a[al]break end end;b[a4]={r=z,p=function(am,P)Z(P,ak and("Boot%s %s from %s (%s)"):format(am and"ing"or"",ak,a5(z.getLabel()or"N/A",6),a5(x,am and g>80 and 36 or 6))or("Boot from %s (%s) isn't available"):format(z.getLabel()or"N/A",a5(x,am and g>80 and 36 or 6)),F,not am and 0xffffff)end}b[a4].b=function()local an,ao,v,ap,w=z.open(ak,"r"),""::M::v=z.read(an,math.huge)if v then ao=ao..v;goto M end;z.close(an)a0("Hold any button to boot",F,math.huge,0,function()if i then W()b[a4].p(1,h/2)end;if computer.getBootAddress()~=x then computer.setBootAddress(x)end;ap,w=p(ao,"="..ak,setmetatable({},{__index=_G}),1,1)a0(w,[[¯\_(ツ)_/¯]],math.huge,0,computer.shutdown,w,ap)end,F,f or not e)end or computer.uptime;l[a4]={a5(z.getLabel()or"N/A",6),b[a4].b}end end;local function aq(ar)b={}l={s=ar or 1}aj(computer.getBootAddress())for x in next,component.list"file"do aj(x~=computer.getBootAddress()and x or"")end end;local function as()f=1::at::local au,av,aw,ax,ay,K,q,az,ao,aA,P,aB,s,L=function(aC,P,aD,aE,aF,aG)local aH,O=0;for a4=1,#aC do aH=aH+unicode.len(aC[a4][1])+aD end;aH=aH-aD;O=X(aH)if aG then aG()end;for a4=1,#aC do if aC.s==a4 and aF then T(O-aD/2,P-math.floor(aE/2),unicode.len(aC[a4][1])+aD,aE,0x8cb9c5)N(O,P,aC[a4][1],0x8cb9c5,0x002b36)else N(O,P,aC[a4][1],0x002b36,0x8cb9c5)end;O=O+unicode.len(aC[a4][1])+aD end end;ax=function()P=h/2-(#b>0 and-1 or 1)W()au(l,P-4,8,3,not ay.p and 1,function()if#b>0 then aB=b[l.s].r;b[l.s].p(F,P+3)Z(P+5,("Storage %s%% / %s / %s"):format(math.floor(aB.spaceUsed()/(aB.spaceTotal()/100)),aB.isReadOnly()and"Read only"or"Read & Write",aB.spaceTotal()<2^20 and"FDD"or aB.spaceTotal()<2^20*12 and"HDD"or"RAID"))for a4=av,#aw do aw[a4]=F end;if not aB.isReadOnly()then aw[av]={"Rename",function()W()Z(h/2-1,"Change label",F,0xffffff)az=a7("Enter new name: ",F,h/2+1,1,F,0x8cb9c5)if az and#az>0 then aB.setLabel(az)aq(l.s)end end}aw[av+1]={"Format",function()aB.remove("/")aB.setLabel(F)aq(l.s)end}end else Z(P+3,"No drives available",F,0xffffff)end end)au(aw,P,6,1,ay.p and 1 or F)end;aw={s=1,p=1,{"Halt",computer.shutdown},{"Shell",function()W()s=setmetatable({print=ai,proxy=z,sleep=G},{__index=_G})::M::ao=a7("> ",1,h,F,ao)if ao then ai("> "..ao)N(1,h,">")ai(select(2,p(ao,"=shell",s,F,1)))goto M end end},{"Netboot",function()W()Z(h/2-1,"Internet boot",F,0xffffff)aA=a7("URL: ",F,h/2+1,1,F,0x8cb9c5)if aA and#aA>0 then local an,ao,v=z"net".request(aA,F,F,{["user-agent"]="Cyan"}),""if an then a0("Downloading script...","Internet boot")::M::v=an.read()if v then ao=ao..v;goto M end;ao=select(2,p(ao,"=stdin",setmetatable({},{__index=_G}),1,pcall))or""a0(ao,"Internet boot",#ao==0 and 0 or math.huge)else a0("Invalid URL","Internet boot",math.huge)end end end}}av=#aw+1;j=F;_()aq()ay=#b>0 and l or aw::M::ax()K,L,L,q=m()if K=="F"then computer.shutdown()else if K:match"do"then ay=(q==200 or q==208)and(#b>0 and(ay.p and l or aw)or ay)or ay;ay.s=q==203 and(ay.s==1 and#ay or ay.s-1)or q==205 and(ay.s==#ay and 1 or ay.s+1)or ay.s;if q==28 then ay[ay.s][2]()end end;if K:match"mp"or j then goto at end end;goto M end;computer.getBootAddress=z"pro".getData;computer.setBootAddress=z"pro".setData;aq()a0("Hold ALT to stay in bootloader",F,1,56,as,F)for a4=1,#b do b[a4].b()end;a0("No drives available",F,F,F,as,F,1)