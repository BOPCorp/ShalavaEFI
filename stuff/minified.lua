local a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=component,computer,unicode,{"/init.lua","/OS.lua"},{},{},{n=0},F;local function q(r)local s={b.pullSignal(r)}s[1]=s[1]or""if#s>0 and g.n>0 and(s[1]:match("ey")and not g[s[5]]or s[1]:match("cl")and not g[s[4]])then return""end;f[s[4]or""]=s[1]:match"do"and 1;if f[29]and(f[46]or f[32])and s[1]:match"do"then return"F"end;return table.unpack(s)end;local function t(u,v,w,x,y)y=y or xpcall;local z,A=load("return "..u,v,F,w)if not z then z,A=load(u,v,F,w)end;if z then w=a.invoke;a.invoke=x and m and m.address and function(B,C,...)if m and B==m.address and C=="set"then m.setPaletteColor(9,0x969696)m.setPaletteColor(11,0xb4b4b4)end;a.invoke=w;return w(B,C,...)end or w;return y(z,debug.traceback)end;return F,A end;local function D(E)return a.list(E)()and a.proxy(a.list(E)())end;local function G(H,I)o={}for J in H:gmatch"[^\r\n]+"do o[#o+1]=J:gsub("\t",I and"    "or"")end end;local function K(r,L,M)local N,O,u,P=b.uptime()+(r or math.huge)::Q::O,P,P,u=q(N-b.uptime())if O=="F"or O:match"do"and(u==L or L==0)then return 1,M and M()elseif b.uptime()<N then goto Q end end;local function R(S,T,U,V,W)m.setBackground(V or 0x002b36)m.setForeground(W or 0x8cb9c5)m.set(S,T,U)end;local function X(S,T,Y,Z,V,W)m.setBackground(V or 0x002b36)m.setForeground(W or 0x8cb9c5)m.fill(S,T,Y,Z," ")end;local function _()X(1,1,k,l)end;local function a0(a1)return math.floor(k/2-a1/2)end;local function a2(T,H,V,W)R(a0(c.len(H)),T,H,V,W)end;local function a3()m=D"gp"if m and m.bind(component.list"sc"())then m.setPaletteColor(9,0x002b36)m.setPaletteColor(11,0x8cb9c5)k,l=m.maxResolution()_()return 1 end;k,l=0,0 end;local function a4(H,a5,a6,L,M,A,a7)if a3()then G(H)local T=math.ceil(l/2-#o/2)T=a7 and M()or T;if a5 then a2(T-1,a5,0x002b36,0xffffff)T=T+1 end;for a8=1,#o do a2(T,o[a8])T=T+1 end;K(a6 or 0,L or 0,M)elseif A then error(H)end end;local function a9(H,aa)return c.len(H)>aa and c.sub(H,1,aa).."…"or H end;local function ab(ac,T,ad,ae,W,w)local H,af,ag,ah,ai,S,O,aj,u,P="",c.len(ac),1,1;W=W or 0x8cb9c5::Q::S=ad and a0(c.len(H)+af)or 1;ai=S+af+ag-1;X(1,T,k,1)R(S,T,ac..H,F,W)if ai<=k then R(ai,T,m.get(ai,T),ah and W or 0x002b36,ah and 0x002b36 or W)end;O,P,aj,u=q(.5)if O:match"do"then if u==203 and ag>1 then ag=ag-1 elseif u==205 and ag<=c.len(H)then ag=ag+1 elseif u==200 and ae then H=ae;ag=c.len(ae)+1 elseif u==208 and ae then H=""ag=1 elseif u==14 and#H>0 and ag>1 then H=f[29]and""or c.sub(c.sub(H,1,ag-1),1,-2)..c.sub(H,ag,-1)ag=f[29]and 1 or ag-1 elseif u==28 then return H elseif aj>=32 and c.len(af..H)<k-af then H=c.sub(H,1,ag-1)..c.char(aj)..c.sub(H,ag,-1)ag=ag+1 end;ah=1 elseif O:match"cl"then H=c.sub(H,1,ag-1)..aj..c.sub(H,ag,-1)ag=ag+c.len(aj)elseif O:match"mp"or O=="F"then n=O:match"mp"and 1;return elseif not O:match"up"then ah=not ah end;goto Q end;local function ak(...)local H=table.pack(...)for a8=1,H.n do H[a8]=tostring(H[a8])end;G(table.concat(H,"    "),1)for a8=1,#o do m.copy(1,1,k,l-1,0,-1)X(1,l-1,k,1)R(1,l-1,o[a8])end end;local function al(B)local D,am,a8=a.proxy(B)if D and B~=b.tmpAddress()then a8=#e+1;for an=1,#d do if D.exists(d[an])then am=d[an]break end end;e[a8]={r=D,p=function(ao,T)a2(T,am and("Boot%s %s from %s (%s)"):format(ao and"ing"or"",am,a9(D.getLabel()or"N/A",6),a9(B,ao and k>80 and 36 or 6))or("Boot from %s (%s) isn't available"):format(D.getLabel()or"N/A",a9(B,ao and k>80 and 36 or 6)),F,not ao and 0xffffff)end}e[a8].b=function()if am then local ap,aq,z,ar,A=D.open(am,"r"),""::Q::z=D.read(ap,math.huge)if z then aq=aq..z;goto Q end;D.close(ap)a4("Hold any button to boot",F,math.huge,0,function()if m then _()e[a8].p(1,l/2)end;if j~=B then b.setBootAddress(B)end;ar,A=t(aq,"="..am,F,1)a4(A,[[¯\_(ツ)_/¯]],math.huge,0,b.shutdown,1)end,F,i or not h)end end or b.uptime;p[a8]={a9(D.getLabel()or"N/A",6),e[a8].b}end end;local function as(at)e={}p={s=at or 1}al(j)for B in next,a.list"file"do al(B~=j and B or"")end end;local function au()i=1::av::local aw,ax,ay,az,aA,O,u,aB,aq,aC,T,aD,w,P=function(aE,T,aF,aG,aH,aI)local aJ,S=0;for a8=1,#aE do aJ=aJ+c.len(aE[a8][1])+aF end;aJ=aJ-aF;S=a0(aJ)if aI then aI()end;for a8=1,#aE do if aE.s==a8 and aH then X(S-aF/2,T-math.floor(aG/2),c.len(aE[a8][1])+aF,aG,0x8cb9c5)R(S,T,aE[a8][1],0x8cb9c5,0x002b36)else R(S,T,aE[a8][1],0x002b36,0x8cb9c5)end;S=S+c.len(aE[a8][1])+aF end end;az=a3()and function()T=l/2-(#e>0 and-1 or 1)_()aw(p,T-4,8,3,not aA.p and 1,function()if#e>0 then aD=e[p.s].r;e[p.s].p(F,T+3)a2(T+5,("Storage %s%% / %s / %s"):format(math.floor(aD.spaceUsed()/(aD.spaceTotal()/100)),aD.isReadOnly()and"Read only"or"Read & Write",aD.spaceTotal()<2^20 and"FDD"or aD.spaceTotal()<2^20*12 and"HDD"or"RAID"))for a8=ax,#ay do ay[a8]=F end;if not aD.isReadOnly()then ay[ax]={"Rename",function()_()a2(l/2-1,"Change label",F,0xffffff)aB=ab("Enter new name: ",l/2+1,1,F,0x8cb9c5)if aB and#aB>0 then aD.setLabel(aB)as(p.s)end end}ay[ax+1]={"Format",function()aD.remove("/")aD.setLabel(F)as(p.s)end}end else a2(T+3,"No drives available",F,0xffffff)end end)aw(ay,T,6,1,aA.p and 1 or F)end or b.uptime;ay={s=1,p=1,{"Halt",b.shutdown},{"Shell",function()_()w=setmetatable({print=ak,proxy=D,sleep=K},{__index=_G})::Q::aq=ab("> ",l,F,aq,0xffffff,w)if aq then ak("> "..aq)R(1,l,">")ak(select(2,t(aq,"=shell",w)))goto Q end end},D"net"and{"Netboot",function()_()a2(l/2-1,"Internet boot",F,0xffffff)aC=ab("URL: ",l/2+1,1,F,0x8cb9c5)if aC and#aC>0 then local ap,aq,z=D"net".request(aC,F,F,{["user-agent"]="Cyan"}),""if ap then a4("Downloading script...","Internet boot")::Q::z=ap.read()if z then aq=aq..z;goto Q end;aq=select(2,t(aq,"=stdin",F,1,pcall))or""a4(aq,"Internet boot",#aq==0 and 0 or math.huge)else a4("Invalid URL","Internet boot",math.huge)end end end}}ax=#ay+1;n=F;as()aA=#e>0 and p or ay::Q::az()O,P,P,u=q()if O=="F"then b.shutdown()else if O:match"do"then aA=(u==200 or u==208)and(#e>0 and(aA.p and p or ay)or aA)or aA;aA.s=u==203 and(aA.s==1 and#aA or aA.s-1)or u==205 and(aA.s==#aA and 1 or aA.s+1)or aA.s;if u==28 then aA[aA.s][2]()end;az()end;if O:match"mp"or n then goto av end end;goto Q end;b.getBootAddress=D"pro".getData;b.setBootAddress=D"pro".setData;j=b.getBootAddress()as()a4("Hold ALT to stay in bootloader",F,1,56,au,F)for a8=1,#e do e[a8].b()end;a4("No drives available",F,F,F,au,1,1)