local a,b,c,d,e,f,g,h,i,j,k,l=%users%,%checkUserOnBoot%,{"/init.lua","/OS.lua"},{},{},unicode,computer;a.n=#a;for m=1,#a do a[a[m]],a[m]=1,F end;local function n(o)local p={g.pullSignal(o or math.huge)}if#p>0 and a.n>0 and(p[1]:match("key")and not a[p[5]]or p[1]:match("clip")and not a[p[4]])then return{""}end;e[p[4]or""]=p[1]=="key_down"and 1;if e[29]and(e[56]and e[46]or e[32])then return"F"end;return table.unpack(p)end;local function q(r)local address=component.list(r)()return address and component.proxy(address)end;local function s(t,u,v)local w,x=load("return "..t,u,F,v)if not w then w,x=load(t,u,F,v)end;if w then return xpcall(w,debug.traceback)else return F,x end end;local function y(z,A)local B={}for C in z:gmatch"[^\r\n]+"do B[#B+1]=C:gsub("\t",A and"    "or"")end;return B end;local function D(o,E,G)local H,I,t,J=g.uptime()+(o or math.huge)repeat I,J,J,t=n(H-g.uptime())if I=="F"or I=="key_down"and(t==E or E==0)then if G then G()end;return 1 end until g.uptime()>=H end;local K,L,M=q"gp"or{},q"pr",component.list"sc"()g.setBootAddress=L.setData;g.getBootAddress=L.getData;L.get=L.getData;if K and M then K.bind(M)j,k=K.maxResolution()i=k/2;K.setPaletteColor(9,0x002b36)K.setPaletteColor(11,0x8cb9c5)end;local function N(O,P,Q,R,S)K.setBackground(R or 0x002b36)K.setForeground(S or 0x8cb9c5)K.set(O,P,Q)end;local function T(O,P,U,V,W,R,S)K.setBackground(R or 0x002b36)K.setForeground(S or 0x8cb9c5)K.fill(O,P,U,V,W)end;local function X()T(1,1,j,k," ")end;local function Y(Z)return math.ceil(j/2-Z/2)end;local function _(P,z,R,S)N(Y(f.len(z)),P,z,R,S)end;local function a0(z,a1,a2,E,G,a3,x)if K and M then local B,P,a4=y(z),g.uptime()+(a2 or 0),K.set;P=math.ceil(i-#B/2)K.setPaletteColor(9,0x002b36)K.setPaletteColor(11,0x8cb9c5)X()if a1 then _(P-1,a1,0x002b36,0xFFFFFF)P=P+1 end;for m=1,#B do _(P,B[m])P=P+1 end;if a3 and K and M then K.set=function(...)K.setPaletteColor(9,0x969696)K.setPaletteColor(11,0xb4b4b4)a4(...)K.set=a4 end end;if x then g.beep(1000,.4)g.beep(1000,.4)end;return D(a2 or 0,E,G)end end;local function a5(x)return K and M and a0(x,[[¯\_(ツ)_/¯]],math.huge,0,g.shutdown,1)or error(x)end;local function a6(address)local q=component.proxy(address)if q and q.spaceTotal then d[#d+1]={q,q.getLabel()or"N/A",address}for m=1,#c do if q.exists(c[m])then d[#d][4]=c[m]end end end end;local function a7()d={}a6(L.getData())for a8 in pairs(component.list"sy")do a6(L.getData()~=a8 and g.tmpAddress()~=a8 and a8 or"")end end;local function a9(z,aa)return f.len(z)>aa and f.sub(z,1,aa).."…"or z end;local function ab(ac,ad,P,ae,af)local ab,ag,ah,ai,O,aj,I,ak,t,J="",f.len(ac),1,1;while 1 do I,J,ak,t=n(.5)if I=="F"then ab=F;break elseif I=="key_down"then if ak>=32 and f.len(ag..ab)<j-ag-1 then ab=f.sub(ab,1,ah-1)..f.char(ak)..f.sub(ab,ah,-1)ah=ah+1 elseif ak==8 and#ab>0 then ab=f.sub(f.sub(ab,1,ah-1),1,-2)..f.sub(ab,ah,-1)ah=ah-1 elseif ak==13 then break elseif t==203 and ah>1 then ah=ah-1 elseif t==205 and ah<=f.len(ab)then ah=ah+1 elseif t==200 and af then ab=af;ah=f.len(af)+1 elseif t==208 and af then ab=""ah=1 end;ai=1 elseif I:match("clip")then ab=f.sub(ab,1,ah-1)..ak..f.sub(ab,ah,-1)ah=ah+f.len(ak)elseif I~="key_up"then ai=not ai end;O=ae and Y(f.len(ab)+ag)or ad;aj=O+ag+ah-1;T(1,P,j,1," ")N(O,P,ac..ab,0x002b36,0xFFFFFF)if aj<=j then N(aj,P,K.get(aj,P),ai and 0xFFFFFF or 0x002b36,ai and 0x002b36 or 0xFFFFFF)end end;T(1,P,j,1," ")return ab end;local function al(...)local z,B=table.pack(...)for m=1,z.n do z[m]=tostring(z[m])end;B=y(table.concat(z,"    "),1)for m=1,#B do K.copy(1,1,j,k-1,0,-1)T(1,k-1,j,1," ")N(1,k-1,B[m])end end;local function am(an,a3)address=a9(an[3],a3 and 36 or 6)return an[4]and("Boot%s %s from %s (%s)"):format(a3 and"ing"or"",an[4],an[2],address)or("Boot from %s (%s) is not available"):format(an[2],address)end;local function ao(an)if an[4]then local ap,aq,w,ar,x,ao=an[1].open(an[4],"r"),""::as::w=an[1].read(ap,math.huge)if w then aq=aq..w;goto as end;an[1].close(ap)ao=function()a0(am(an,1),F,.5,F,F,1)if L.getData()~=an[3]then L.setData(an[3])end;ar,x=s(aq,"="..an[4])if not ar then a5(x)end;return 1 end;aq=b and a0("Hold any button to boot",F,math.huge,0,ao)or ao()end end;local function at(au,P,av,aw,ax)return{e=au,s=1,y=P,k=aw,b=av,d=function(ay,az,aA)P=ay.y;av=ay.b;T(1,P-1,j,3," ",0x002b36)h=aA and h or ay;local aB,aC,aD,O,aE,aF=0,av==1 and 6 or 8;if ax then ax(ay)end;for m=1,#ay.e do aB=aB+f.len(ay.e[m].t)+aC end;aB=aB-aC;O=Y(aB)for m=1,#ay.e do aE,aF=ay.s==m and 1,ay.e[m]aD=f.len(aF.t)if aE and not az then T(O-aC/2,P-(av==1 and 0 or 1),aD+aC,av==1 and 1 or 3," ",0x8cb9c5)N(O,P,aF.t,0x8cb9c5,0x002b36)else N(O,P,aF.t,0x002b36,0x8cb9c5)end;O=O+aD+aC end end}end;local function aG()::aH::l=q"et"a7()local v,I,t,aq,aI,aJ,aK,an,q,aL,aM,aN,ap,w,aO,aP,J=setmetatable({print=al,proxy=q,os={sleep=function(o)D(o)end},read=function(af)al(" ")local aq=ab("",1,k-1,F,af)N(1,k-1,aq or"")return aq end},{__index=_G})aI=at({{t="Power off",a=function()g.shutdown()end},{t="Lua",a=function()X()::as::aq=ab("> ",1,k,F,aq)if aq then al("> "..aq)N(1,k,">")al(select(2,s(aq,"=stdin",v)))goto as end;aK(F,F,1,1)end}},i+2,1,function()h=aJ;aK(1,1,F,F)end)aI.e[#aI.e+1]=l and{t="Netboot",a=function()aN,aq=ab("URL: ",F,i+7,1),""if aN and aN~=""then ap,w=l.request(aN),""if ap then a0("Downloading "..aN.."...")::as::w=ap.read()if w then aq=aq..w;goto as end;ap.close()a0(select(2,s(aq,"=netboot"))or"is empty","Netboot:",math.huge,0)else a0("Malformed URL","Netboot:",math.huge,0)end end;aK(F,F,1,1)end}if#d>0 then aO=#aI.e+1;aJ=at({},i-2,2,function()h=aI;aK(F,F,1,1)end,function(ay)an=d[ay.s]q=an[1]aP=q.spaceTotal()aL=q.isReadOnly()T(1,i+5,j,3," ")_(i+5,am(an),F,0xFFFFFF)_(i+7,("Disk usage %s%% / %s / %s"):format(math.floor(q.spaceUsed()/(aP/100)),aL and"Read only"or"Read & Write",aP<2^20 and"FDD"or aP<2^20*12 and"HDD"or"RAID"))for m=aO,#aI.e do aI.e[m]=F end;if aL then aI.s=aI.s>#aI.e and#aI.e or aI.s else aI.e[aO]={t="Rename",a=function()aM=ab("New label: ",F,i+7,1)if aM and aM~=""then pcall(q.setLabel,aM)an[2]=a9(aM,16)aJ.e[ay.s].t=a9(aM,6)end;aJ:d(1,1)aI:d()end}aI.e[#aI.e+1]={t="Format",a=function()an[4]=F;q.remove("/")aJ:d(1,1)aI:d()end}end;aI:d(1,1)end)for m=1,#d do aJ.e[m]={t=a9(d[m][2],6),a=function(ay)ao(d[ay.s])end}end else aI.y=i;aI.b=2 end;aK=function(aQ,aR,aS,aT)X()if aJ then aJ:d(aS,aT)aI:d(aQ,aR)else _(i+4,"No drives available",0x002b36,0xFFFFFF)aI:d()end;_(k,"Use ← ↑ → key to move cursor; Enter to do action; CTRL+D to shutdown")end;aK(1,1)::as::I,J,J,t=n()if I=="key_down"then if t==200 then h.k()elseif t==208 then h.k()elseif t==203 then h.s=h.s>1 and h.s-1 or#h.e;h:d()elseif t==205 then h.s=h.s<#h.e and h.s+1 or 1;h:d()elseif t==28 then h.e[h.s].a(h)end elseif I:match("component")then goto aH elseif I=="F"then g.shutdown()end;goto as end;g.beep(1000,.2)a7()a0("Hold CTRL to stay in bootloader",F,.5,29,aG)for m=1,#d do if ao(d[m])then g.shutdown()end end;l=K and M and aG()or error"No bootable medium found"