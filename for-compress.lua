local a,b,c,d,e,f,g,h,i,j,k,l,m="%pass%",%passOnBoot%,{"/init.lua","/OS.lua"},{},{},unicode,computer;local function n(o,p)local q={g.pullSignal(o)}if q[1]=="key_down"then e[q[4]]=1 elseif q[1]=="key_up"then e[q[4]]=F end;if e[29]and e[56]and e[46]then if p then p()end;return"interrupted"elseif e[29]and e[32]then return"interrupted"else return table.unpack(q)end end;local function r(s)local address=component.list(s)()return address and component.proxy(address)end;local function t(u,v,w)local x,y=load("return "..u,v,F,w)if not x then x,y=load(u,v,F,w)end;if x then return xpcall(x,debug.traceback)else return F,y end end;local function z(A,B)local C={}for D in A:gmatch"[^\r\n]+"do C[#C+1]=D:gsub("\t",B and"    "or"")end;return C end;local function E(o,G,H)local I,J,u,K=g.uptime()+(o or math.huge)repeat J,K,K,u=n(I-g.uptime())if J=="interrupted"or J=="key_down"and(u==G or G==0)then if H then H()end;return 1 end until g.uptime()>=I end;local L,M,N=r"gp"or{},r"pr",component.list"sc"()g.setBootAddress=M.setData;g.getBootAddress=M.getData;M.get=M.getData;if L and N then L.bind(N)k,l=L.maxResolution()j=l/2;L.setPaletteColor(9,0x002b36)L.setPaletteColor(11,0x8cb9c5)end;local function O(P,Q,R,S,T)L.setBackground(S or 0x002b36)L.setForeground(T or 0x8cb9c5)L.set(P,Q,R)end;local function U(P,Q,V,W,X,S,T)L.setBackground(S or 0x002b36)L.setForeground(T or 0x8cb9c5)L.fill(P,Q,V,W,X)end;local function Y()U(1,1,k,l," ")end;local function Z(_)return math.ceil(k/2-_/2)end;local function a0(Q,A,S,T)O(Z(f.len(A)),Q,A,S,T)end;local function a1(A,a2,a3,G,H,a4,a5)if L and N then local C,Q,a6=z(A),g.uptime()+(a3 or 0),L.set;Q=math.ceil(j-#C/2)L.setPaletteColor(9,0x002b36)L.setPaletteColor(11,0x8cb9c5)Y()if a2 then a0(Q-1,a2,0x002b36,0xFFFFFF)Q=Q+1 end;for a7=1,#C do a0(Q,C[a7])Q=Q+1 end;if a4 and L and N then L.set=function(...)L.setPaletteColor(9,0x969696)L.setPaletteColor(11,0xb4b4b4)a6(...)L.set=a6 end end;if a5 then g.beep(1000,.4)g.beep(1000,.4)end;return E(a3 or 0,G,H)end end;local function a8(y)return L and N and a1(y,[[¯\_(ツ)_/¯]],math.huge,0,g.shutdown,1)or error(y)end;local function a9(address)local r=component.proxy(address)if r and r.spaceTotal then d[#d+1]={r,r.getLabel()or"N/A",address}for a7=1,#c do if r.exists(c[a7])then d[#d][4]=c[a7]end end end end;local function aa()d={}a9(M.getData())for ab in pairs(component.list"sy")do a9(M.getData()~=ab and g.tmpAddress()~=ab and ab or"")end end;local function ac(A,ad)return f.len(A)>ad and f.sub(A,1,ad).."…"or A end;local function ae(af,ag,Q,ah,ai,aj)local ae,ak,al,am,P,an,J,ao,u,K="",f.len(af),1,1;while 1 do J,K,ao,u=n(.5)if J=="interrupted"then ae=F;break elseif J=="key_down"then if ao>=32 and f.len(ak..ae)<k-ak-1 then ae=f.sub(ae,1,al-1)..f.char(ao)..f.sub(ae,al,-1)al=al+1 elseif ao==8 and#ae>0 then ae=f.sub(f.sub(ae,1,al-1),1,-2)..f.sub(ae,al,-1)al=al-1 elseif ao==13 then break elseif u==203 and al>1 then al=al-1 elseif u==205 and al<=f.len(ae)then al=al+1 elseif u==200 and aj then ae=aj;al=f.len(aj)+1 elseif u==208 and aj then ae=""al=1 end;am=1 elseif J=="clipboard"then ae=f.sub(ae,1,al-1)..ao..f.sub(ae,al,-1)al=al+f.len(ao)elseif J~="key_up"then am=not am end;P=ah and Z(f.len(ae)+ak)or ag;an=P+ak+al-1;U(1,Q,k,1," ")O(P,Q,af..(ai and("*"):rep(f.len(ae))or ae),0x002b36,0xFFFFFF)if an<=k then O(an,Q,L.get(an,Q),am and 0xFFFFFF or 0x002b36,am and 0x002b36 or 0xFFFFFF)end end;U(1,Q,k,1," ")return ae end;local function ap(...)local A,C=table.pack(...)for a7=1,A.n do A[a7]=tostring(A[a7])end;C=z(table.concat(A,"    "),1)for a7=1,#C do L.copy(1,1,k,l-1,0,-1)U(1,l-1,k,1," ")O(1,l-1,C[a7])end end;local function aq()if#a>0 and not h then local ar=ae("Password: ",F,j,1,1)if not ar then g.shutdown()elseif ar~=a then a8"Access denied"end;h=1 end end;local function as(at,a4)address=ac(at[3],a4 and 36 or 6)return at[4]and("Boot%s %s from %s (%s)"):format(a4 and"ing"or"",at[4],at[2],address)or("Boot from %s (%s) is not available"):format(at[2],address)end;local function au(at)if at[4]then local av,aw,x,ax,y=at[1].open(at[4],"r"),""::ay::x=at[1].read(av,math.huge)if x then aw=aw..x;goto ay end;at[1].close(av)if b then aq()end;a1(as(at,1),F,.5,F,F,1)if M.getData()~=at[3]then M.setData(at[3])end;ax,y=t(aw,"="..at[4])if not ax then a8(y)end;return 1 end end;local function az(aA,Q,aB,aC,aD)return{e=aA,s=1,y=Q,k=aC,b=aB,d=function(aE,aF,aG)Q=aE.y;aB=aE.b;U(1,Q-1,k,3," ",0x002b36)i=aG and i or aE;local aH,aI,aJ,P,aK,aL=0,aB==1 and 6 or 8;if aD then aD(aE)end;for a7=1,#aE.e do aH=aH+f.len(aE.e[a7].t)+aI end;aH=aH-aI;P=Z(aH)for a7=1,#aE.e do aK,aL=aE.s==a7 and 1,aE.e[a7]aJ=f.len(aL.t)if aK and not aF then U(P-aI/2,Q-(aB==1 and 0 or 1),aJ+aI,aB==1 and 1 or 3," ",0x8cb9c5)O(P,Q,aL.t,0x8cb9c5,0x002b36)else O(P,Q,aL.t,0x002b36,0x8cb9c5)end;P=P+aJ+aI end end}end;local function aM()aq()::aN::m=r"et"aa()local w,J,u,aw,aO,aP,aQ,at,r,aR,aS,aT,av,x,aU,aV,K=setmetatable({print=ap,proxy=r,os={sleep=function(o)E(o,F,function()error"interrupted"end)end},read=function(ai,aj)ap(" ")local aw=ae("",1,l-1,F,ai,aj)O(1,l-1,aw or"")return aw end},{__index=_G})aO=az({{t="Power off",a=function()g.shutdown()end},{t="Lua",a=function()Y()::ay::aw=ae("> ",1,l,F,F,aw)if aw then ap("> "..aw)O(1,l,">")ap(select(2,t(aw,"=stdin",w)))goto ay end;aQ(F,F,1,1)end}},j+2,1,function()i=aP;aQ(1,1,F,F)end)aO.e[#aO.e+1]=m and{t="Internet boot",a=function()aT,aw=ae("URL: ",F,j+7,1),""if aT and aT~=""then av,x=m.request(aT),""if av then a1"Downloading..."::ay::x=av.read()if x then aw=aw..x;goto ay end;av.close()a1(select(2,t(aw,"=stdin"))or"is empty","Internet boot result",math.huge,0)else a1("Malformed URL","Internet boot result",math.huge,0)end end;aQ(F,F,1,1)end}if#d>0 then aU=#aO.e+1;aP=az({},j-2,2,function()i=aO;aQ(F,F,1,1)end,function(aE)at=d[aE.s]r=at[1]aV=r.spaceTotal()aR=r.isReadOnly()U(1,j+5,k,3," ")a0(j+5,as(at),F,0xFFFFFF)a0(j+7,("Disk usage %s%% / %s / %s"):format(math.floor(r.spaceUsed()/(aV/100)),aR and"Read only"or"Read & Write",aV<2^20 and"FDD"or aV<2^20*12 and"HDD"or"RAID"))for a7=aU,#aO.e do aO.e[a7]=F end;if aR then aO.s=aO.s>#aO.e and#aO.e or aO.s else aO.e[aU]={t="Rename",a=function()aS=ae("New label: ",F,j+7,1)if aS and aS~=""then pcall(r.setLabel,aS)at[2]=ac(aS,16)aP.e[aE.s].t=ac(aS,6)end;aP:d(1,1)aO:d()end}aO.e[#aO.e+1]={t="Format",a=function()at[4]=F;r.remove("/")aP:d(1,1)aO:d()end}end;aO:d(1,1)end)for a7=1,#d do aP.e[a7]={t=ac(d[a7][2],6),a=function(aE)au(d[aE.s])end}end else aO.y=j;aO.b=2 end;aQ=function(aW,aX,aY,aZ)Y()if aP then aP:d(aY,aZ)aO:d(aW,aX)else a0(j+4,"No drives available",0x002b36,0xFFFFFF)aO:d()end;a0(l,"Use ← ↑ → keys to move cursor; Enter to boot; CTRL+ALT+C to shutdown")end;aQ(1,1)::ay::J,K,K,u=n(math.huge,g.shutdown)if J=="key_down"then if u==200 then i.k()elseif u==208 then i.k()elseif u==203 then i.s=i.s>1 and i.s-1 or#i.e;i:d()elseif u==205 then i.s=i.s<#i.e and i.s+1 or 1;i:d()elseif u==28 then i.e[i.s].a(i)end elseif J:match("component")then goto aN end;goto ay end;g.beep(1000,.2)aa()a1("Hold CTRL to stay in bootloader",F,.5,29,aM)for a7=1,#d do if au(d[a7])then g.shutdown()end end;if L and N then aM()else error"No bootable medium found"end